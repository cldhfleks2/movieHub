<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 관리 페이지</title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/manager/post.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="adminSideBar">
    <div class="siteLogo">관리자 페이지</div>
    <button class="adminMainpageBtn" onclick="window.location.href='/main'">메인 페이지로</button>
    <button class="adminLogoutBtn" onclick="window.location.href='/logout'">로그아웃</button>
    <hr>
    <div class="navMenu">
        <a class="menuItem" id="movieMenu" href="/manager/movie">
            <span>🎬</span> 영화 관리
        </a>
        <a class="menuItem" id="reviewMenu" href="/manager/movieReview">
            <span>💬</span> 영화 리뷰 관리
        </a>
        <a class="menuItem active" id="postMenu">
            <span>💬</span> 게시물 관리
        </a>
    </div>
</div>

<main class="container" id="postContainer">
    <div class="searchSection">
        <div class="searchHeader">
            <h2>게시글 검색</h2>
            <select class="searchType" id="postTypeSelect">
                <option value="ALL">전체</option>
                <option value="FREE">자유 게시판</option>
                <option value="NEWS">소식 게시판</option>
                <option value="DISCUSSION">토론 게시판</option>
            </select>
        </div>
        <div class="searchBar">
            <input type="text" id="searchInput" placeholder="제목 또는 작성자로 검색...">
            <button class="searchBtn">검색</button>
        </div>
    </div>

    <div class="searchResults">
        <table class="resultTable">
            <thead>
            <tr>
                <th>번호</th>
                <th>게시판</th>
                <th>제목</th>
                <th>작성자</th>
                <th>작성일</th>
                <th>조회수</th>
                <th>관리</th>
            </tr>
            </thead>
            <tbody id="searchResultBody">

            <tr class="postRow">
                <td class="postNumber">1</td>
                <td class="postType">자유 게시판</td>
                <td class="postTitle">
                    <span class="titleText">첫 번째 게시글입니다</span>
                    <span class="commentCount">[3]</span>
                </td>
                <td class="postAuthor">홍길동</td>
                <td class="postDate">2024-01-05</td>
                <td class="postView">42</td>
                <td class="postManage">
                    <button class="editBtn" th:data-post-id=1>수정 하기</button>
                </td>
            </tr>

            </tbody>
        </table>
    </div>

    <div class="pagination" id="paginationContainer">
        <!-- 페이지네이션 버튼들이 여기에 동적으로 추가됨 -->
        <button class="pageBtn">이전</button>
        <div class="pageNumbers">
            <button class="pageNum active">1</button>
            <button class="pageNum">2</button>
            <button class="pageNum">3</button>
        </div>
        <button class="pageBtn">다음</button>
    </div>

<!--게시글 상세 정보 (댓글 포함)-->
    <div class="postDetailSection" id="postDetailSection">
        <h3>게시글 상세 정보</h3>
        <div class="detailContainer">
            <!-- 왼쪽: 작성자 프로필 섹션 -->
            <div class="authorSection">
                <div class="profileImage">
                    <img id="authorProfileImg" src="/image/blank.png" alt="프로필 이미지">
                </div>
                <div class="authorInfo">
                    <div class="authorNickname">
                        <label>닉네임</label>
                        <span id="detailAuthorNickname"></span>
                    </div>
                    <div class="authorUsername">
                        <label>아이디</label>
                        <span id="detailAuthorUsername"></span>
                    </div>
                    <div class="postDate">
                        <label>작성일</label>
                        <span id="detailDate"></span>
                    </div>
                </div>
            </div>

            <!-- 오른쪽: 게시글 수정 섹션 -->
            <div class="editSection">
                <form id="postDetailForm">
                    <input type="hidden" id="postId">
                    <div class="formGroup">
                        <label for="detailPostType">게시판 종류</label>
                        <select id="detailPostType">
                            <option value="FREE">자유 게시판</option>
                            <option value="NEWS">소식 게시판</option>
                            <option value="DISCUSSION">토론 게시판</option>
                        </select>
                    </div>
                    <div class="formGroup">
                        <label for="detailTitle">제목</label>
                        <input type="text" id="detailTitle">
                    </div>
                    <div class="formGroup">
                        <label for="detailContent">내용</label>
                        <textarea id="detailContent" rows="15"></textarea>
                    </div>
                    <div class="statsGroup">
                        <div class="statItem">
                            <label>조회수</label>
                            <span id="detailViews"></span>
                        </div>
                        <div class="statItem">
                            <label>댓글</label>
                            <span id="detailComments"></span>
                        </div>
                        <div class="statItem">
                            <label>좋아요</label>
                            <span id="detailLikes"></span>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="buttonGroup">
            <button type="button" class="saveBtn">저장</button>
            <button type="button" class="deleteBtn">삭제</button>
            <button type="button" class="cancelBtn">취소</button>
        </div>

        <!-- 댓글 섹션 추가 -->
        <div class="reviewSection" id="reviewsSection">
            <h3>댓글 (
                <span class="reviewCount" th:if="${postReviewCnt}" th:text="${postReviewCnt}">0</span>
                <span class="reviewCount" th:unless="${postReviewCnt}">0</span>
                )
            </h3>

            <!-- 댓글 목록 -->
            <div class="reviewList" id="reviewList">
                <th:block th:if="${not #lists.isEmpty(postReviewDTOList)}">
                    <th:block th:each="review : ${postReviewDTOList}" th:if="${review != null}">
                        <div th:replace="~{:: reviewItemFragment(${review})}"></div> <!--댓글이 여기에 반복됨-->
                    </th:block>
                </th:block>
            </div>

            <!-- 반복될 댓글 내용 -->
            <th:block th:fragment="reviewItemFragment(review)">
                <div th:if="${review != null}"
                     th:id="'reviewItem-' + ${review.id}"
                     class="reviewItem"
                     th:style="${review.depth > 0 ? 'margin-left: ' + (review.depth * 40) + 'px' : ''}">

                    <div class="reviewHeader">
                        <a class="revieworInfo" th:href="@{/userprofile/{memberId}(memberId=${review.member.id})}">
                            <img class="revieworAvatar"
                                 th:src="${review.member.profileImage != null ? review.member.profileImage : '/image/profile.png'}"
                                 alt="프로필">
                            <span class="revieworName" th:text="${review.member.nickname}">닉네임</span>
                        </a>
                        <span class="reviewDate" th:text="${#temporals.format(review.updateDate, 'yyyy-MM-dd HH:mm')}">
                        작성시간
                    </span>
                    </div>

                    <p class="reviewText" th:text="${review.content}">댓글 내용</p>

                    <div class="reviewActions">
                        <button class="editButton" th:data-review-id="${review.id}">
                            <span class="icon">✎</span>
                            <span>댓글 수정</span>
                        </button>
                        <button class="deleteButton" th:data-review-id="${review.id}">
                            <span class="icon">×</span>
                            <span>댓글 삭제</span>
                        </button>
                    </div>

                    <!-- 자식 댓글 재귀 표시 -->
                    <div th:if="${not #lists.isEmpty(review.children)}" class="childReviews">
                        <th:block th:each="childReview : ${review.children}">
                            <div th:replace="~{:: reviewItemFragment(${childReview})}"></div>
                        </th:block>
                    </div>
                </div>
            </th:block>
        </div>
    </div>
</main>

<script>
    window.onload = function() {
        const alertMessage = "[[${alertMessage}]]";
        if (alertMessage) {
            alert(alertMessage);
        }
    };
</script>
<script src="/js/manager/post.js"></script>
</body>
</html>